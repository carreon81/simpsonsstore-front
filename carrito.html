<!-- carrito.html actualizado y corregido -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Carrito</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
        #header-placeholder {
            margin-bottom: 150px;
        }
        footer {
            padding: 30px;
            color: #222 !important;
            font-weight: 300 !important;
            font-size: 12px !important;
        }
        html, body {
            height: 100%;
        }
        body {
            display: flex;
            flex-direction: column;
            max-width: 820px;
            margin: 0 auto;
        }
        main {
            flex: 1;
        }
        button {
            border-radius: 25px !important;
            min-width: 95px;
        }
        h2 {
            font-size: 1.5rem;
            font-weight: 200 !important;
        }
        .btnConfirm {
            width: 195px;
            border: none;
            height: 50px;
            background-color: black;
            margin-top: 25px;
        }
        .btnConfirm:hover {
            background-color: #333;
        }
        .flex {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }
        #headerTitle {
            display: flex;
            width: 100%;
            flex-direction: column;
        }
    </style>
</head>
<body>
<main class="container py-4">
    <div id="header-placeholder"></div>
    <div id="headerTitle" style="display: none">
        <h2>Carrito</h2>
        <hr>
    </div>

    <table class="table table-striped mt-3" id="cartTableContainer">
        <thead>
        <tr>
            <th>Producto</th>
            <th>Cantidad</th>
            <th>Acciones</th>
        </tr>
        </thead>
        <tbody id="cartTable"></tbody>
    </table>

    <div class="flex">
        <button class="btn btn-success btnConfirm" id="checkoutBtn">Confirmar Pedido</button>
    </div>

    <div id="mensaje" class="mt-2"></div>

    <div id="emptyCartMessage" class="text-center mt-5" style="display: none;">
        <img src="https://assets.streamlinehq.com/image/private/w_800,h_800,ar_1/f_auto/v1/icons/seoul/shopping/shopping/empty-cart-9p91f0l3qq8hn5t9m6fqzl.png?_a=DATAdtAAZAA0"
             alt="The Simpsons Logo" style="margin-top: 20px; width: 200px;">
        <p class="lead">No tienes productos agregados al carrito.</p>
    </div>
</main>

<script>
    fetch('header.html')
        .then(response => response.text())
        .then(data => document.getElementById('header-placeholder').innerHTML = data);

    const cartTable = document.getElementById('cartTable');

    async function loadCart() {
        const carrito = JSON.parse(localStorage.getItem('carrito')) || [];

        const tableContainer = document.getElementById('cartTableContainer');
        const headerTitle = document.getElementById('headerTitle');
        const checkoutBtn = document.getElementById('checkoutBtn');
        const emptyCartMessage = document.getElementById('emptyCartMessage');
        const messageAlert = document.getElementById('mensaje');

        cartTable.innerHTML = '';

        if (carrito.length === 0) {
            headerTitle.style.display = 'none';
            tableContainer.style.display = 'none';
            checkoutBtn.style.display = 'none';
            emptyCartMessage.style.display = 'block';
            return;
        } else {
            headerTitle.style.display = 'flex';
            tableContainer.style.display = 'table';
            checkoutBtn.style.display = 'inline-block';
            emptyCartMessage.style.display = 'none';
        }

        for (const item of carrito) {
            const res = await fetch(`http://localhost:8081/productos/${item.productoId}`);
            const producto = await res.json();

            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${producto.name}</td>
                <td>${item.cantidad}</td>
                <td>
                    <button class="btn btn-danger btn-sm" onclick="removeFromCart(${item.productoId})">Eliminar</button>
                </td>
            `;
            cartTable.appendChild(row);
        }
    }

    function removeFromCart(productId) {
        const carrito = JSON.parse(localStorage.getItem('carrito')) || [];
        const index = carrito.findIndex(item => item.productoId === productId);
        if (index !== -1) {
            carrito.splice(index, 1);
            localStorage.setItem('carrito', JSON.stringify(carrito));
            loadCart();
        }
    }

    document.getElementById('checkoutBtn').addEventListener('click', async () => {
        const carrito = JSON.parse(localStorage.getItem('carrito')) || [];
        if (carrito.length === 0) {
            document.getElementById('mensaje').innerHTML = '<div class="alert alert-warning">El carrito está vacío.</div>';
            return;
        }
        try {
            const res = await fetch('http://localhost:8081/pedidos', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ items: carrito })
            });
            if (res.ok) {
                localStorage.removeItem('carrito');
                document.getElementById('mensaje').innerHTML = '<div class="alert alert-success">Pedido realizado correctamente. Redirigiendo al inicio...</div>';
                setTimeout(() => {
                    window.location.href = "index.html";
                }, 1500);
            } else {
                document.getElementById('mensaje').innerHTML = '<div class="alert alert-danger">Error al realizar el pedido.</div>';
            }
        } catch (error) {
            console.error(error);
            document.getElementById('mensaje').innerHTML = '<div class="alert alert-danger">Error al conectar con el servidor.</div>';
        }
    });

    loadCart();
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<footer class="text-center small mt-5 mb-3">
    2025 Emmanuel Carreón | carreonmail@gmail.com | +54 9 11 1234 5678
</footer>
</body>
</html>
